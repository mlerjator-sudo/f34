<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F34 Community Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1a1c2c, #0d0e14);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-download {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .icon-badge {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .filter-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-12">
            <div>
                <h1
                    class="text-4xl font-bold text-white bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                    F34 Community</h1>
                <p class="text-slate-400 mt-2">Discover and download shared configurations</p>
            </div>
            <div class="flex items-center gap-4">
                <a href="admin.html"
                    class="px-6 py-2 rounded-lg glass hover:bg-white/10 transition-colors text-sm">Admin Panel</a>
                <button id="auth-btn"
                    class="px-6 py-2 rounded-lg glass hover:bg-white/10 transition-colors text-sm">Login with
                    Google</button>
            </div>
        </header>

        <div class="mb-8">
            <div id="category-filter" class="flex flex-wrap gap-2">
                <button
                    class="filter-btn active px-4 py-2 rounded-lg glass text-[10px] font-bold uppercase tracking-wider transition-all"
                    data-category="all">All</button>
            </div>
        </div>

        <div id="config-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="loading-state" class="col-span-full glass p-12 text-center text-xl animate-pulse">
                Loading configurations...
            </div>
        </div>
    </div>

    <script type="module">
        const log = (msg) => console.log(`[F34] ${msg}`);

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { initializeFirestore, collection, query, where, onSnapshot, getDocs, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA827pUzqfTpGpGbT9uKXKEjZo3hYl5ENo",
            authDomain: "f34-di.firebaseapp.com",
            projectId: "f34-di",
            storageBucket: "f34-di.firebasestorage.app",
            messagingSenderId: "660590227115",
            appId: "1:660590227115:web:0f1ca3aa9464f2406c11ee"
        };

        let db, auth, provider;
        let currentUser = null;
        let mcAccount = null;
        let currentCategory = 'all';
        let allConfigs = [];
        let dataLoaded = false;

        try {
            const app = initializeApp(firebaseConfig);
            db = initializeFirestore(app, { experimentalForceLongPolling: true });
            auth = getAuth(app);
            provider = new GoogleAuthProvider();

            const configList = document.getElementById('config-list');
            const filterContainer = document.getElementById('category-filter');
            const authBtn = document.getElementById('auth-btn');

            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                if (user) {
                    try {
                        const userDoc = await getDoc(doc(db, "users", user.email));
                        if (userDoc.exists()) {
                            mcAccount = userDoc.data();
                            authBtn.innerHTML = `<div class="flex items-center gap-3">
                                <img src="https://mc-heads.net/avatar/${mcAccount.mc_name}/32" class="w-8 h-8 rounded border border-white/20" alt="Skin">
                                <div class="text-left">
                                    <div class="text-[10px] opacity-50 leading-none">Logged in as</div>
                                    <div class="font-bold">${mcAccount.mc_name}</div>
                                </div>
                            </div>`;
                        } else {
                            authBtn.textContent = 'Link Minecraft (Login in Mod)';
                        }
                    } catch (e) { log("Auth Doc Error: " + e.message); }
                } else {
                    authBtn.textContent = 'Login with Google';
                }
                renderConfigs();
            });

            authBtn.onclick = async () => {
                if (currentUser) signOut(auth);
                else {
                    try {
                        await signInWithPopup(auth, provider).catch(async (err) => {
                            if (['auth/popup-blocked', 'auth/popup-closed-by-user', 'auth/cancelled-popup-request'].includes(err.code)) {
                                await signInWithRedirect(auth, provider);
                            } else throw err;
                        });
                    } catch (e) { alert("Login failed: " + e.message); }
                }
            };

            const CATEGORIES = ["Adventure", "Horror", "Decoration", "Economy", "Equipment", "Food", "Game Mechanics", "Library", "Magic", "Management", "Minigame", "Mobs", "Optimization", "Social", "Storage", "Technology", "Transportation", "Utility", "World Gen", "General", "Convenience"];
            CATEGORIES.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn px-4 py-2 rounded-lg glass text-[10px] font-bold uppercase tracking-wider transition-all';
                btn.textContent = cat;
                btn.dataset.category = cat;
                btn.onclick = () => setFilter(cat);
                filterContainer.appendChild(btn);
            });
            document.querySelector('[data-category="all"]').onclick = () => setFilter('all');

            function setFilter(cat) {
                currentCategory = cat;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.category === cat));
                renderConfigs();
            }

            const q = query(collection(db, "shared_configs"), where("status", "==", "approved"));

            getDocs(q).then(snap => {
                if (dataLoaded) return;
                processSnapshot(snap);
            }).catch(err => {
                if (!dataLoaded) fetchViaREST();
            });

            setTimeout(() => {
                if (!dataLoaded) fetchViaREST();
            }, 3000);

            async function fetchViaREST() {
                if (dataLoaded) return;
                try {
                    const url = `https://firestore.googleapis.com/v1/projects/f34-di/databases/(default)/documents/shared_configs`;
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.documents) {
                        allConfigs = data.documents
                            .map(doc => {
                                const fields = doc.fields;
                                const obj = { id: doc.name.split('/').pop() };
                                for (let key in fields) {
                                    obj[key] = fields[key].stringValue || fields[key].integerValue || fields[key].doubleValue || fields[key].booleanValue || null;
                                }
                                return obj;
                            })
                            .filter(c => c.status === 'approved');
                        dataLoaded = true;
                        renderConfigs();
                    }
                } catch (e) { log("REST Fallback Failed: " + e.message); }
            }

            function processSnapshot(snap) {
                allConfigs = [];
                snap.forEach(doc => allConfigs.push({ id: doc.id, ...doc.data() }));
                dataLoaded = true;
                renderConfigs();
                onSnapshot(q, (s) => {
                    allConfigs = [];
                    s.forEach(doc => allConfigs.push({ id: doc.id, ...doc.data() }));
                    renderConfigs();
                });
            }

            function renderConfigs() {
                if (!dataLoaded) return;
                const filtered = currentCategory === 'all' ? allConfigs : allConfigs.filter(c => c.category === currentCategory);
                if (filtered.length === 0) {
                    configList.innerHTML = `<div class="col-span-full glass p-12 text-center text-xl">${allConfigs.length === 0 ? 'No configurations found yet.' : 'No results in this category.'}</div>`;
                    return;
                }
                configList.innerHTML = '';
                filtered.forEach((data) => {
                    const div = document.createElement('div');
                    div.className = 'glass p-6 card-hover flex flex-col justify-between';
                    let btnSummary = '';
                    try {
                        const config = JSON.parse(data.config_json);
                        if (config.buttons) {
                            btnSummary = `<div class="flex flex-wrap gap-2 mt-4">
                                ${config.buttons.slice(0, 4).map(b => `<span class="icon-badge px-2 py-1 rounded text-[10px]">${b.name || 'Button'}</span>`).join('')}
                            </div>`;
                        }
                    } catch (e) { }
                    div.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-bold">${data.name || 'Untitled'}</h3>
                                    <span class="text-[10px] text-blue-400 font-bold uppercase tracking-wider">${data.category || 'General'}</span>
                                </div>
                                <span class="text-[10px] opacity-40 font-mono">${data.downloads || 0} DLs</span>
                            </div>
                            <p class="text-slate-400 text-xs mt-1">by ${data.author ? data.author.split('@')[0] : 'Unknown'}</p>
                            <p class="mt-4 text-sm text-slate-300 line-clamp-2">"${data.description || 'No description.'}"</p>
                            ${btnSummary}
                        </div>
                        <button onclick="handleDownload('${data.id}')" class="btn-download mt-6 w-full py-3 rounded-xl font-bold text-white transition-transform active:scale-95 ${(!currentUser || !mcAccount) ? 'opacity-50 cursor-not-allowed' : ''}">${(currentUser && mcAccount) ? 'Download' : (currentUser ? 'Link Minecraft' : 'Login to Download')}</button>
                    `;
                    configList.appendChild(div);
                });
            }

            window.handleDownload = async (id) => {
                if (!currentUser) { alert('Please login with Google.'); return; }
                if (!mcAccount) { alert('Please link Minecraft in the mod first.'); return; }
                try {
                    const docRef = doc(db, "shared_configs", id);
                    const snap = await getDoc(docRef);
                    if (!snap.exists()) return;
                    const data = snap.data();
                    const blob = new Blob([data.config_json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${data.name.replaceAll(' ', '_')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    await updateDoc(docRef, { downloads: increment(1) });
                } catch (e) { alert("Download failed."); }
            };
        } catch (e) { log("Init Error: " + e.message); }
    </script>
</body>

</html>
